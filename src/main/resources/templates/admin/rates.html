<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>管理者画面</title>
	<style>
		.deleted-row {
			background-color: #eee;
			color: #777;
		}
	</style>
</head>

<body>
	<h1>管理者：レート一覧</h1>
	<div>
		<a th:href="@{/admin/rates}">レート一覧</a> |
		<a th:href="@{/admin/users}">ユーザ管理</a> |
		<form method="post" action="/logout" style="display: inline;">
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
			<button type="submit">ログアウト</button>
		</form>
	</div>
	<hr>

	<table border="1">
		<thead>
			<tr>
				<th>ID</th>
				<th>ユーザ</th>
				<th>基準通貨</th>
				<th>対象通貨</th>
				<th>レート</th>
				<th>金額</th>
				<th>変換後</th>
				<th>日時</th>
				<th>削除者</th>
				<th>削除日時</th>
				<th>操作</th>
			</tr>
		</thead>

		<tbody>
			<tr th:each="rate : ${rates}" th:classappend="${rate.deleted} ? 'deleted-row'">

				<td th:text="${rate.id}"></td>
				<td th:text="${rate.username}"></td>
				<td th:text="${rate.baseCurrency}"></td>
				<td th:text="${rate.targetCurrency}"></td>
				<td th:text="${#numbers.formatDecimal(rate.rate, 1, 'COMMA', 4, 'POINT')}"></td>
				<td th:text="${#numbers.formatDecimal(rate.amount, 1, 'COMMA', 2, 'POINT')}"></td>
				<td th:text="${#numbers.formatDecimal(rate.convertedAmount, 1, 'COMMA', 2, 'POINT')}"></td>
				<td th:text="${rate.fetchedAtText}"></td>

				<!-- 削除情報 -->
				<td th:text="${rate.deletedBy}"></td>
				<td th:text="${rate.deletedAt != null ? #temporals.format(rate.deletedAt, 'yyyy-MM-dd HH:mm:ss') : ''}">
				</td>

				<td>
					<!-- 論理削除されていない場合のみ「削除」ボタンを表示 -->
					<div th:if="${!rate.deleted}">
						<form th:action="@{/admin/rates/delete}" method="post">
							<input type="hidden" name="id" th:value="${rate.id}" />
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							<button type="submit" onclick="return confirm('この履歴を削除しますか？');">削除</button>
						</form>
					</div>

					<!-- 論理削除済みの場合は「完全削除」ボタン -->
					<div th:if="${rate.deleted}">
						<form th:action="@{/admin/rates/hard-delete}" method="post">
							<input type="hidden" name="id" th:value="${rate.id}" />
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
							<button type="submit" onclick="return confirm('完全に削除しますか？');">完全削除</button>
						</form>
					</div>
				</td>
			</tr>
		</tbody>
	</table>

	<div>
		<span th:if="${ratePage.hasPrevious()}">
			<a th:href="@{/admin/rates(page=${ratePage.number - 1})}">前へ</a>
		</span>
		<span>ページ [[${ratePage.number + 1}]] / [[${ratePage.totalPages}]]</span>
		<span th:if="${ratePage.hasNext()}">
			<a th:href="@{/admin/rates(page=${ratePage.number + 1})}">次へ</a>
		</span>
	</div>

</body>

</html>